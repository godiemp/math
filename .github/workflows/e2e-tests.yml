name: E2E Tests

on:
  pull_request:
    branches: ['*']
  push:
    branches: ['main', 'master']

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests
    permissions:
      contents: read
      pull-requests: write
      issues: write

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: paes_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      TEST_DATABASE_URL: postgresql://testuser:testpassword@localhost:5433/paes_test
      DATABASE_URL: postgresql://testuser:testpassword@localhost:5433/paes_test
      NODE_ENV: test
      # SECURITY: Minimum 32 characters required (for tests only - use secure secrets in production)
      JWT_SECRET: test-jwt-secret-key-for-e2e-tests-minimum-32-chars
      JWT_REFRESH_SECRET: test-jwt-refresh-secret-key-for-e2e-tests-minimum-32-chars
      # NextAuth secret for session encryption (test-only value)
      AUTH_SECRET: test-auth-secret-key-for-e2e-tests-minimum-32-characters
      FRONTEND_URL: http://localhost:3000
      NEXT_PUBLIC_API_URL: http://localhost:3002

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find or create initial test status comment
        if: github.event_name == 'pull_request'
        id: initial-comment
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- e2e-test-status -->';
            const body = marker + '\n‚è≥ E2E tests are running...\n\n**Status:** In progress\n**Commit:** ' + context.sha.substring(0, 7);

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(c => c.body.includes(marker));

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              return existingComment.id;
            } else {
              // Create new comment
              const comment = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              return comment.data.id;
            }
          result-encoding: string

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Start backend server
        working-directory: ./backend
        env:
          PORT: 3002
        run: |
          npm start &
          echo $! > backend.pid
          # Wait for backend to be ready
          timeout 30 bash -c 'until curl -f http://localhost:3002/health; do sleep 2; done'

      - name: Build frontend
        run: npm run build

      - name: Start frontend server
        env:
          PORT: 3000
        run: |
          npm start &
          echo $! > frontend.pid
          # Wait for frontend to be ready
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload screenshots and test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

      - name: Update PR comment with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testStatus = '${{ job.status }}';
            const emoji = testStatus === 'success' ? '‚úÖ' : '‚ùå';
            const statusText = testStatus === 'success' ? 'passed' : 'failed';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const marker = '<!-- e2e-test-status -->';
            const comment = `${marker}
            ## ${emoji} E2E Tests ${statusText}

            **Test Status:** ${statusText}
            **Commit:** ${context.sha.substring(0, 7)}

            ${testStatus === 'failure' ? '‚ö†Ô∏è Tests failed. Check the artifacts below for details.' : 'üéâ All tests passed!'}

            ### üì¶ Test Artifacts
            - üìä [View HTML Report](${runUrl}#artifacts) - Download \`playwright-report\` artifact
            - üì∏ [View Screenshots & Videos](${runUrl}#artifacts) - Download \`playwright-screenshots\` artifact

            **How to access artifacts:**
            1. Click on the links above to go to the Actions run page
            2. Scroll to the "Artifacts" section at the bottom
            3. Download the artifacts to view screenshots, videos, and detailed HTML reports
            `;

            const commentId = '${{ steps.initial-comment.outputs.result }}';

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: comment
              });
            }

      - name: Cleanup
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
          fi
          if [ -f backend/backend.pid ]; then
            kill $(cat backend/backend.pid) || true
          fi
